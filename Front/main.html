<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniTrip - Káº¿ hoáº¡ch má»›i</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f9fafb; /* bg-gray-50 */
        }
        /* Checkbox mÃ u cam */
        .form-check {
            accent-color: #F97316; /* orange-600 */
        }
        /* TÃ¹y chá»‰nh mÅ©i tÃªn cá»§a <details> */
        details summary {
            list-style: none; /* XÃ³a mÅ©i tÃªn máº·c Ä‘á»‹nh */
            position: relative;
        }
        details summary::-webkit-details-marker {
            display: none;
        }
        details summary::after {
            content: '+'; /* KÃ½ tá»± khi Ä‘Ã³ng */
            font-family: 'Inter';
            font-weight: 700;
            font-size: 1.5em;
            color: #fb923c; /* orange-400 */
            position: absolute;
            right: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s;
        }
        details[open] summary::after {
            content: 'âˆ’'; /* KÃ½ tá»± khi má»Ÿ */
            transform: translateY(-50%) rotate(180deg);
        }
        details[open] summary {
            background-color: #fff7ed; /* orange-50 */
        }
        
        /* CSS cho Google Autocomplete Dropdown (quan trá»ng) */
        .pac-container {
            z-index: 9999 !important;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
        }
        .pac-item {
            padding: 10px;
            font-size: 1rem;
            border-top: 1px solid #f3f4f6; /* bg-gray-100 */
        }
        .pac-item:first-child {
            border-top: none;
        }
        .pac-item-query {
            font-weight: 600;
            color: #1f2937; /* text-gray-800 */
        }
        .pac-matched {
            font-weight: 700;
            color: #ea580c; /* text-orange-600 */
        }
        .pac-icon {
            display: none;
        }
    </style>
</head>
<body>

    <script id="preferences-data" type="application/json">
    [
      {
        "id": "purpose_tourism",
        "name_jp": "è¦³å…‰ãƒ»æ¢ç´¢",
        "description_jp": "å®šç•ªã®å ´æ‰€ã‚„ã€ãã®åœŸåœ°ãªã‚‰ã§ã¯ã®ã‚¹ãƒãƒƒãƒˆã‚’è¨ªã‚ŒãŸã„ã€‚",
        "preferences": [
          { "id": "pref_landmark", "name_jp": "åæ‰€ãƒ»ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯" },
          { "id": "pref_shrine", "name_jp": "ç¥ç¤¾ä»é–£" },
          { "id": "pref_historical", "name_jp": "æ­´å²çš„å»ºé€ ç‰©ãƒ»å²è·¡" },
          { "id": "pref_viewpoint", "name_jp": "å±•æœ›å°ãƒ»ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒãƒƒãƒˆ" },
          { "id": "pref_pilgrimage", "name_jp": "è–åœ°å·¡ç¤¼ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ»ãƒ‰ãƒ©ãƒï¼‰" },
          { "id": "pref_tower", "name_jp": "ã‚¿ãƒ¯ãƒ¼ãƒ»é«˜å±¤ãƒ“ãƒ«" },
          { "id": "pref_hidden_gem", "name_jp": "ç©´å ´ã‚¹ãƒãƒƒãƒˆ" },
          { "id": "pref_free_spot", "name_jp": "ç„¡æ–™è¦³å…‰ã‚¹ãƒãƒƒãƒˆ" },
          { "id": "pref_museum_art", "name_jp": "ç¾è¡“é¤¨" },
          { "id": "pref_museum_history", "name_jp": "åšç‰©é¤¨" }
        ]
      },
      {
        "id": "purpose_relax",
        "name_jp": "ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ»ä¼‘æ†©",
        "description_jp": "å°‘ã—ã®é–“ã€ã‚†ã£ãã‚Šä¼‘ã¿ãŸã„ã€‚é™ã‹ãªå ´æ‰€ã§éã”ã—ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_cafe", "name_jp": "ã‚«ãƒ•ã‚§" },
          { "id": "pref_kissaten", "name_jp": "å–«èŒ¶åº—ï¼ˆãƒ¬ãƒˆãƒ­ï¼‰" },
          { "id": "pref_park", "name_jp": "å…¬åœ’ãƒ»ç·‘åœ°" },
          { "id": "pref_garden", "name_jp": "åº­åœ’" },
          { "id": "pref_waterside", "name_jp": "æ°´è¾ºï¼ˆå·ãƒ»æµ·ãƒ»æ¹–ï¼‰" },
          { "id": "pref_footbath", "name_jp": "è¶³æ¹¯" },
          { "id": "pref_library", "name_jp": "å›³æ›¸é¤¨" },
          { "id": "pref_net_cafe", "name_jp": "æ¼«ç”»å–«èŒ¶ãƒ»ãƒãƒƒãƒˆã‚«ãƒ•ã‚§" },
          { "id": "pref_sento", "name_jp": "ã‚¹ãƒ¼ãƒ‘ãƒ¼éŠ­æ¹¯ãƒ»æ—¥å¸°ã‚Šæ¸©æ³‰" },
          { "id": "pref_massage", "name_jp": "ãƒãƒƒã‚µãƒ¼ã‚¸ãƒ»ãƒªãƒ©ã‚¯ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³" }
        ]
      },
      {
        "id": "purpose_healing",
        "name_jp": "ç™’ã—ãƒ»ãƒ’ãƒ¼ãƒªãƒ³ã‚°",
        "description_jp": "å¿ƒèº«ã¨ã‚‚ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ãŸã„ã€‚äº”æ„Ÿã§ç™’ã•ã‚ŒãŸã„ã€‚",
        "preferences": [
          { "id": "pref_nature_walk", "name_jp": "æ£®æ—æµ´ãƒ»è‡ªç„¶æ•£ç­–" },
          { "id": "pref_botanical_garden", "name_jp": "æ¤ç‰©åœ’" },
          { "id": "pref_aroma", "name_jp": "ã‚¢ãƒ­ãƒãƒ»ãŠé¦™" },
          { "id": "pref_spa_este", "name_jp": "ã‚¹ãƒ‘ãƒ»ã‚¨ã‚¹ãƒ†" },
          { "id": "pref_yoga", "name_jp": "ç‘æƒ³ãƒ»ãƒ¨ã‚¬ã‚¹ã‚¿ã‚¸ã‚ª" },
          { "id": "pref_quiet_shrine", "name_jp": "é™ã‹ãªç¥ç¤¾ä»é–£" },
          { "id": "pref_animal_cafe", "name_jp": "å‹•ç‰©ã‚«ãƒ•ã‚§" },
          { "id": "pref_music_classic", "name_jp": "éŸ³æ¥½é‘‘è³ï¼ˆã‚¯ãƒ©ã‚·ãƒƒã‚¯ãƒ»ã‚¸ãƒ£ã‚ºï¼‰" },
          { "id": "pref_planetarium", "name_jp": "ãƒ—ãƒ©ãƒã‚¿ãƒªã‚¦ãƒ " }
        ]
      },
      {
        "id": "purpose_gourmet",
        "name_jp": "ã‚°ãƒ«ãƒ¡ãƒ»é£Ÿäº‹",
        "description_jp": "ç¾å‘³ã—ã„ã‚‚ã®ã‚’é£Ÿã¹ãŸã„ã€‚é£Ÿäº‹ã‚’ãƒ¡ã‚¤ãƒ³ã«ã—ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_street_food", "name_jp": "é£Ÿã¹æ­©ã" },
          { "id": "pref_local_gourmet", "name_jp": "Bç´šãƒ»ã”å½“åœ°ã‚°ãƒ«ãƒ¡" },
          { "id": "pref_set_meal", "name_jp": "ãƒ­ãƒ¼ã‚«ãƒ«é£Ÿå ‚ãƒ»å®šé£Ÿå±‹" },
          { "id": "pref_sweets", "name_jp": "ã‚¹ã‚¤ãƒ¼ãƒ„ãƒ»ãƒ‡ã‚¶ãƒ¼ãƒˆ" },
          { "id": "pref_bakery", "name_jp": "ãƒ‘ãƒ³å±‹ãƒ»ãƒ™ãƒ¼ã‚«ãƒªãƒ¼" },
          { "id": "pref_ramen", "name_jp": "ãƒ©ãƒ¼ãƒ¡ãƒ³" },
          { "id": "pref_sushi", "name_jp": "å¯¿å¸" },
          { "id": "pref_ethnic", "name_jp": "ã‚¨ã‚¹ãƒ‹ãƒƒã‚¯æ–™ç†" },
          { "id": "pref_izakaya", "name_jp": "å±…é…’å±‹ãƒ»ç«‹ã¡é£²ã¿" },
          { "id": "pref_allyoucan", "name_jp": "é£Ÿã¹æ”¾é¡Œãƒ»é£²ã¿æ”¾é¡Œ" },
          { "id": "pref_late_night", "name_jp": "æ·±å¤œå–¶æ¥­ã‚°ãƒ«ãƒ¡" }
        ]
      },
      {
        "id": "purpose_stroll",
        "name_jp": "æ•£ç­–ãƒ»è¡—æ­©ã",
        "description_jp": "ã‚ã¦ã‚‚ãªãæ­©ããªãŒã‚‰ã€è¡—ã®é›°å›²æ°—ã‚’æ„Ÿã˜ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_alley", "name_jp": "è·¯åœ°è£ãƒ»æ¨ªä¸" },
          { "id": "pref_architecture", "name_jp": "å»ºç¯‰å·¡ã‚Š" },
          { "id": "pref_shotengai", "name_jp": "æ˜”ãªãŒã‚‰ã®å•†åº—è¡—" },
          { "id": "pref_slope_stairs", "name_jp": "å‚é“ãƒ»éšæ®µ" },
          { "id": "pref_market", "name_jp": "å¸‚å ´ï¼ˆãƒãƒ¼ã‚±ãƒƒãƒˆï¼‰" },
          { "id": "pref_window_shopping", "name_jp": "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°" },
          { "id": "pref_riverside", "name_jp": "å·æ²¿ã„ãƒ»æµ·è¾ºã®æ•£æ­©" },
          { "id": "pref_night_walk", "name_jp": "å¤œã®æ•£æ­©" }
        ]
      },
      {
        "id": "purpose_learn_experience",
        "name_jp": "å­¦ã³ãƒ»ä½“é¨“",
        "description_jp": "ä½•ã‹ã‚’æ–°ã—ãçŸ¥ã‚ŠãŸã„ã€æ–‡åŒ–ã‚„èŠ¸è¡“ã«è§¦ã‚ŒãŸã„ã€‚",
        "preferences": [
          { "id": "pref_art_gallery", "name_jp": "ç¾è¡“é¤¨ãƒ»ã‚®ãƒ£ãƒ©ãƒªãƒ¼" },
          { "id": "pref_museum", "name_jp": "åšç‰©é¤¨ãƒ»ç§‘å­¦é¤¨" },
          { "id": "pref_aquarium_zoo", "name_jp": "æ°´æ—é¤¨ãƒ»å‹•ç‰©åœ’" },
          { "id": "pref_workshop", "name_jp": "ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ãƒ»æ–‡åŒ–ä½“é¨“" },
          { "id": "pref_crafts", "name_jp": "ä¼çµ±å·¥èŠ¸" },
          { "id": "pref_factory_tour", "name_jp": "å·¥å ´è¦‹å­¦" },
          { "id": "pref_cinema", "name_jp": "æ˜ ç”»é¤¨ï¼ˆãƒŸãƒ‹ã‚·ã‚¢ã‚¿ãƒ¼ï¼‰" },
          { "id": "pref_theater_live", "name_jp": "åŠ‡å ´ãƒ»ãƒ©ã‚¤ãƒ–ãƒã‚¦ã‚¹" },
          { "id": "pref_seminar", "name_jp": "è¬›æ¼”ãƒ»ã‚»ãƒŸãƒŠãƒ¼" }
        ]
      },
      {
        "id": "purpose_shopping",
        "name_jp": "ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°",
        "description_jp": "ãŠåœŸç”£ã‚’æ¢ã—ãŸã„ã€è²·ã„ç‰©ã‚’ã—ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_souvenir", "name_jp": "ãŠåœŸç”£" },
          { "id": "pref_zakka", "name_jp": "é›‘è²¨å±‹" },
          { "id": "pref_select_shop", "name_jp": "ã‚»ãƒ¬ã‚¯ãƒˆã‚·ãƒ§ãƒƒãƒ—" },
          { "id": "pref_used_clothes", "name_jp": "å¤ç€å±‹" },
          { "id": "pref_department_store", "name_jp": "ãƒ‡ãƒ‘ãƒ¼ãƒˆãƒ»å•†æ¥­æ–½è¨­" },
          { "id": "pref_drugstore", "name_jp": "ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢" },
          { "id": "pref_100yen_shop", "name_jp": "100å††ã‚·ãƒ§ãƒƒãƒ—" },
          { "id": "pref_local_supermarket", "name_jp": "åœ°å…ƒã®ã‚¹ãƒ¼ãƒ‘ãƒ¼" },
          { "id": "pref_electronics", "name_jp": "å®¶é›»é‡è²©åº—" },
          { "id": "pref_antique", "name_jp": "éª¨è‘£å“ãƒ»ã‚¢ãƒ³ãƒ†ã‚£ãƒ¼ã‚¯" }
        ]
      },
      {
        "id": "purpose_photo",
        "name_jp": "å†™çœŸãƒ»SNSæ˜ ãˆ",
        "description_jp": "ç´ æ•µãªå†™çœŸã€SNSã§å…±æœ‰ã—ãŸããªã‚‹å†™çœŸã‚’æ’®ã‚ŠãŸã„ã€‚",
        "preferences": [
          { "id": "pref_sns_hotspot", "name_jp": "SNSã§è©±é¡Œã®ã‚¹ãƒãƒƒãƒˆ" },
          { "id": "pref_stylish_cafe", "name_jp": "ãŠã—ã‚ƒã‚Œãªã‚«ãƒ•ã‚§" },
          { "id": "pref_cute_sweets", "name_jp": "å¯æ„›ã„ã‚¹ã‚¤ãƒ¼ãƒ„" },
          { "id": "pref_street_art", "name_jp": "å£ç”»ãƒ»ã‚¹ãƒˆãƒªãƒ¼ãƒˆã‚¢ãƒ¼ãƒˆ" },
          { "id": "pref_arch_photo", "name_jp": "å°è±¡çš„ãªå»ºç¯‰" },
          { "id": "pref_night_view", "name_jp": "å¤œæ™¯ãƒ»ãƒ©ã‚¤ãƒˆã‚¢ãƒƒãƒ—" },
          { "id": "pref_retro_spot", "name_jp": "ãƒ¬ãƒˆãƒ­ãƒ»ãƒã‚¹ã‚¿ãƒ«ã‚¸ãƒƒã‚¯ãªé¢¨æ™¯" },
          { "id": "pref_scenic_view", "name_jp": "çµ¶æ™¯ãƒ»é¢¨æ™¯" }
        ]
      },
      {
        "id": "purpose_nature",
        "name_jp": "è‡ªç„¶ãƒ»é¢¨æ™¯",
        "description_jp": "ç·‘ã‚„æ°´è¾ºã€è‰¯ã„æ™¯è‰²ã‚’è¦‹ã¦ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_park_green", "name_jp": "å…¬åœ’ãƒ»ç·‘åœ°" },
          { "id": "pref_garden_jp", "name_jp": "æ—¥æœ¬åº­åœ’" },
          { "id": "pref_waterside_walk", "name_jp": "æ°´è¾ºï¼ˆå·ãƒ»æµ·ãƒ»æ¹–ï¼‰" },
          { "id": "pref_viewpoint_high", "name_jp": "é«˜å°ãƒ»å±•æœ›ã‚¹ãƒãƒƒãƒˆ" },
          { "id": "pref_botanical", "name_jp": "æ¤ç‰©åœ’" },
          { "id": "pref_seasonal_flower", "name_jp": "å­£ç¯€ã®èŠ±ï¼ˆæ¡œãƒ»ç´…è‘‰ãªã©ï¼‰" },
          { "id": "pref_hiking_light", "name_jp": "è»½ã„ãƒã‚¤ã‚­ãƒ³ã‚°ãƒ»ç™»å±±" }
        ]
      },
      {
        "id": "purpose_mood_change",
        "name_jp": "æ°—åˆ†è»¢æ›",
        "description_jp": "ã¡ã‚‡ã£ã¨ã—ãŸæ™‚é–“ã§ã€æ°—åˆ†ã‚’ã‚¹ãƒƒã‚­ãƒªã•ã›ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_good_view", "name_jp": "æ™¯è‰²ã®è‰¯ã„å ´æ‰€" },
          { "id": "pref_quiet_cafe", "name_jp": "é™ã‹ãªã‚«ãƒ•ã‚§" },
          { "id": "pref_park_walk", "name_jp": "å…¬åœ’ã§æ•£æ­©" },
          { "id": "pref_karaoke", "name_jp": "ã‚«ãƒ©ã‚ªã‚±ï¼ˆ1äººOKï¼‰" },
          { "id": "pref_game_center", "name_jp": "ã‚²ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼" },
          { "id": "pref_batting_center", "name_jp": "ãƒãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚»ãƒ³ã‚¿ãƒ¼" },
          { "id": "pref_bookstore", "name_jp": "æœ¬å±‹ã§ç«‹ã¡èª­ã¿" }
        ]
      },
      {
        "id": "purpose_local_experience",
        "name_jp": "ãƒ­ãƒ¼ã‚«ãƒ«ä½“é¨“",
        "description_jp": "åœ°å…ƒã®äººã€…ã®æ—¥å¸¸ã‚„æ–‡åŒ–ã«è§¦ã‚ŒãŸã„ã€‚",
        "preferences": [
          { "id": "pref_local_market", "name_jp": "åœ°å…ƒã®å¸‚å ´" },
          { "id": "pref_old_shotengai", "name_jp": "æ˜”ãªãŒã‚‰ã®å•†åº—è¡—" },
          { "id": "pref_local_super", "name_jp": "åœ°å…ƒã®ã‚¹ãƒ¼ãƒ‘ãƒ¼" },
          { "id": "pref_public_bath", "name_jp": "éŠ­æ¹¯" },
          { "id": "pref_yokocho", "name_jp": "æ¨ªä¸ãƒ»é£²ã¿å±‹è¡—" },
          { "id": "pref_local_diner", "name_jp": "ãƒ­ãƒ¼ã‚«ãƒ«é£Ÿå ‚" },
          { "id": "pref_local_event", "name_jp": "åœ°åŸŸã®ãŠç¥­ã‚Šãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ" }
        ]
      },
      {
        "id": "purpose_trend",
        "name_jp": "ãƒˆãƒ¬ãƒ³ãƒ‰",
        "description_jp": "ä»Šã€æµè¡Œã£ã¦ã„ã‚‹å ´æ‰€ã‚„ãƒ¢ãƒã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_sns_trending", "name_jp": "SNSã§è©±é¡Œã®åº—" },
          { "id": "pref_new_open", "name_jp": "æ–°ã‚ªãƒ¼ãƒ—ãƒ³ã®åº—" },
          { "id": "pref_trending_gourmet", "name_jp": "æµè¡Œã®ã‚°ãƒ«ãƒ¡" },
          { "id": "pref_popup_store", "name_jp": "ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ãƒˆã‚¢" },
          { "id": "pref_collab_cafe", "name_jp": "ã‚³ãƒ©ãƒœã‚«ãƒ•ã‚§" }
        ]
      },
      {
        "id": "purpose_active",
        "name_jp": "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–",
        "description_jp": "å°‘ã—ä½“ã‚’å‹•ã‹ã—ãŸã„ã€æ´»æ°—ã®ã‚ã‚‹å ´æ‰€ã«è¡ŒããŸã„ã€‚",
        "preferences": [
          { "id": "pref_walking", "name_jp": "ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°" },
          { "id": "pref_rental_cycle", "name_jp": "ãƒ¬ãƒ³ã‚¿ã‚µã‚¤ã‚¯ãƒ«" },
          { "id": "pref_bouldering", "name_jp": "ãƒœãƒ«ãƒ€ãƒªãƒ³ã‚°" },
          { "id": "pref_game_arcade", "name_jp": "ã‚²ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼" },
          { "id": "pref_sports_watch", "name_jp": "ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦" },
          { "id": "pref_pool", "name_jp": "å…¬å…±ãƒ—ãƒ¼ãƒ«" }
        ]
      },
      {
        "id": "purpose_reward",
        "name_jp": "è‡ªåˆ†ã«ã”è¤’ç¾",
        "description_jp": "ã„ã¤ã‚‚ã‚ˆã‚Šå°‘ã—è´…æ²¢ãªæ™‚é–“ã‚’éã”ã—ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_luxury_sweets", "name_jp": "é«˜ç´šã‚¹ã‚¤ãƒ¼ãƒ„ãƒ»ãƒ‘ãƒ•ã‚§" },
          { "id": "pref_good_lunch", "name_jp": "ã¡ã‚‡ã£ã¨è‰¯ã„ãƒ©ãƒ³ãƒãƒ»ãƒ‡ã‚£ãƒŠãƒ¼" },
          { "id": "pref_spa_treatment", "name_jp": "ã‚¹ãƒ‘ãƒ»ã‚¨ã‚¹ãƒ†" },
          { "id": "pref_brand_shopping", "name_jp": "ãƒ–ãƒ©ãƒ³ãƒ‰ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°" },
          { "id": "pref_hotel_lounge", "name_jp": "ãƒ›ãƒ†ãƒ«ã®ãƒ©ã‚¦ãƒ³ã‚¸" },
          { "id": "pref_luxury_goods", "name_jp": "é«˜ç´šé›‘è²¨ãƒ»å°ç‰©" }
        ]
      },
      {
        "id": "purpose_niche",
        "name_jp": "æ·±æ˜ã‚Šãƒ»ãƒãƒ‹ã‚¢ãƒƒã‚¯",
        "description_jp": "è‡ªåˆ†ã®è¶£å‘³ã‚„ã€å°‚é–€çš„ãªåˆ†é‡ã‚’æ·±ãæ¢æ±‚ã—ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_specialty_store", "name_jp": "å°‚é–€åº—ï¼ˆæ¨¡å‹ã€ã‚«ãƒ¡ãƒ©ã€æ–‡å…·ãªã©ï¼‰" },
          { "id": "pref_used_bookstore", "name_jp": "å¤æ›¸åº—" },
          { "id": "pref_record_store", "name_jp": "ãƒ¬ã‚³ãƒ¼ãƒ‰åº—" },
          { "id": "pref_theme_cafe", "name_jp": "ãƒ†ãƒ¼ãƒã‚«ãƒ•ã‚§ï¼ˆå‹•ç‰©ã€ãƒ¡ã‚¤ãƒ‰ã€é‰„é“ãªã©ï¼‰" },
          { "id": "pref_unique_spot", "name_jp": "çã‚¹ãƒãƒƒãƒˆ" },
          { "id": "pref_mini_theater", "name_jp": "ãƒŸãƒ‹ã‚·ã‚¢ã‚¿ãƒ¼ï¼ˆå˜é¤¨ç³»æ˜ ç”»é¤¨ï¼‰" },
          { "id": "pref_architecture_niche", "name_jp": "ãƒãƒ‹ã‚¢ãƒƒã‚¯ãªå»ºç¯‰" }
        ]
      },
      {
        "id": "purpose_kill_time",
        "name_jp": "æ™‚é–“èª¿æ•´",
        "description_jp": "æ¬¡ã®äºˆå®šã¾ã§ã€ã‚µã‚¯ãƒƒã¨æ™‚é–“ã‚’æ½°ã—ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_station_cafe", "name_jp": "é§…è¿‘ã‚«ãƒ•ã‚§" },
          { "id": "pref_bookstore_browse", "name_jp": "æœ¬å±‹ãƒ»æ›¸åº—" },
          { "id": "pref_100yen_drugstore", "name_jp": "100å††ã‚·ãƒ§ãƒƒãƒ—ãƒ»ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢" },
          { "id": "pref_station_building", "name_jp": "é§…ãƒ“ãƒ«ãƒ»é§…ãƒŠã‚«æ–½è¨­" },
          { "id": "pref_fast_food", "name_jp": "ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰" },
          { "id": "pref_arcade", "name_jp": "ã‚²ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼" }
        ]
      },
      {
        "id":"purpose_budget",
        "name_jp": "ç„¡æ–™ãƒ»ç¯€ç´„",
        "description_jp": "ãŠé‡‘ã‚’ã‹ã‘ãšã«æ¥½ã—ã¿ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_free_observatory", "name_jp": "ç„¡æ–™å±•æœ›å°" },
          { "id": "pref_free_museum", "name_jp": "ç„¡æ–™ã®åšç‰©é¤¨ãƒ»è³‡æ–™é¤¨" },
          { "id": "pref_public_facility", "name_jp": "å…¬å…±æ–½è¨­ï¼ˆå›³æ›¸é¤¨ã€åºƒå ´ï¼‰" },
          { "id": "pref_park_large", "name_jp": "å¤§ããªå…¬åœ’" },
          { "id": "pref_free_samples", "name_jp": "è©¦é£Ÿãƒ»è©¦é£²" },
          { "id": "pref_window_shopping_main", "name_jp": "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°" }
        ]
      },
      {
        "id": "purpose_nightlife",
        "name_jp": "å¤œã®æ¥½ã—ã¿",
        "description_jp": "å¤œã®æ™‚é–“å¸¯ãªã‚‰ã§ã¯ã®ä½“é¨“ãŒã—ãŸã„ã€‚",
        "preferences": [
          { "id": "pref_night_view_spot", "name_jp": "å¤œæ™¯ã‚¹ãƒãƒƒãƒˆ" },
          { "id": "pref_bar", "name_jp": "ãƒãƒ¼" },
          { "id": "pref_izakaya_hopping", "name_jp": "å±…é…’å±‹ãƒ»ã¯ã—ã”é…’" },
          { "id": "pref_night_cafe", "name_jp": "å¤œã‚«ãƒ•ã‚§" },
          { "id": "pref_live_house_club", "name_jp": "ãƒ©ã‚¤ãƒ–ãƒã‚¦ã‚¹ãƒ»ã‚¯ãƒ©ãƒ–" },
          { "id": "pref_light_up", "name_jp": "ãƒ©ã‚¤ãƒˆã‚¢ãƒƒãƒ—ãƒ»ã‚¤ãƒ«ãƒŸãƒãƒ¼ã‚·ãƒ§ãƒ³" },
          { "id": "pref_night_bowling", "name_jp": "å¤œã®ãƒœãƒ¼ãƒªãƒ³ã‚°ãƒ»ã‚«ãƒ©ã‚ªã‚±" }
        ]
      },
      {
        "id": "purpose_surprise",
        "name_jp": "ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ»ãŠã¾ã‹ã›",
        "description_jp": "AIã«ã™ã¹ã¦ä»»ã›ã¦ã€ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ä½“é¨“ãŒã—ãŸã„ã€‚",
        "preferences": []
      }
    ]
    </script>

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center">
                      <h1 class="text-2xl font-bold text-orange-600">MiniTrip</h1>
                </div>
                
                <div class="relative">
                    <div>
                        <button type="button" class="bg-white rounded-full flex text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                            <span class="sr-only">Open user menu</span>
                            <svg class="h-8 w-8 rounded-full text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.793 2.39A6.483 6.483 0 0010 16.5a6.483 6.483 0 004.793-2.11A5.99 5.99 0 0010 12z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <div id="user-menu" class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">
                        <div class="px-4 py-2 text-sm text-gray-700" role="none">
                            ã“ã‚“ã«ã¡ã¯ã€ <strong id="welcome-nickname">User</strong>ã•ã‚“
                        </div>
                        <a href="/map?mode=favorites" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                            â¤ï¸ ãŠæ°—ã«å…¥ã‚Š (ä¿å­˜æ¸ˆã¿)
                        </a>
                        <a href="/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1" id="user-menu-item-0">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</a>
                        <button id="logout-button" class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem" tabindex="-1">
                            ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container mx-auto px-4 py-8 md:py-12 flex items-center justify-center">
        
        <div class="bg-white p-6 sm:p-8 md:p-10 rounded-2xl shadow-lg w-full max-w-3xl">
            
            <div class="text-center mb-8">
                <h2 class="text-2xl font-semibold text-gray-700">ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆ</h2>
            </div>

            <form id="mainForm" class="space-y-8">

                <fieldset class="border border-gray-300 rounded-lg p-6">
                    <legend class="text-xl font-semibold text-gray-700 px-2">
                        <span class="text-orange-600">1.</span> ã©ã“ã‹ã‚‰ï¼Ÿ
                    </legend>
                    
                    <div class="space-y-4 mt-4">
                        <div>
                            <label for="location-input" class="block text-sm font-semibold text-gray-700 mb-2">å ´æ‰€ã®åå‰ã§æ¤œç´¢ (ä¾‹: æ±äº¬é§…)</label>
                            <input type="text" id="location-input"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition duration-200"
                                   placeholder="é§…ã€ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã€ã¾ãŸã¯ä½æ‰€...">
                        </div>
                        
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center">
                                <span class="relative px-2 bg-white text-sm text-gray-500">ã¾ãŸã¯</span>
                            </div>
                        </div>

                        <div>
                            <button type="button" id="current-location-btn"
                                    class="w-full flex items-center justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-sm bg-white hover:bg-gray-50 text-gray-700 font-medium transition duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008.051-.023c.27-.124.56-.29.827-.498l.005-.004.014-.01.034-.028.066-.056c.204-.174.39-.36.551-.557l.004-.005.01-.012.019-.024.033-.04.05-.064.07-.09.087-.112.162-.21.21-.273.21-.275.163-.215.056-.075.042-.057.025-.034l.017-.023a9.718 9.718 0 002.508-2.585l.042-.06.03-.046.016-.026.008-.013.004-.006c.41-.646.723-1.33 1.01-2.046l.002-.006.003-.008.001-.002A9.954 9.954 0 0010 2C4.477 2 0 6.477 0 12s4.477 10 10 10a9.954 9.954 0 007.502-3.629l.001-.002.003-.007.002-.006c.287-.716.599-1.4.01-2.046l.004-.006.008-.013.016-.026.03-.046.042-.06a9.718 9.718 0 002.508-2.585l.017-.023.025-.034.042-.057.056-.075.163-.215.21-.275.21-.273.162-.21.087-.112.07-.09.05-.064.033-.04.019-.024.01-.012.004-.005c.162-.197.347-.383.551-.557l.066-.056.034-.028.014-.01.005-.004c.268-.208.557-.374.827-.498l.051-.023.018-.008.006-.003zM10 8a4 4 0 100 8 4 4 0 000-8z" clip-rule="evenodd" />
                                </svg>
                                ç¾åœ¨åœ°ã‚’åˆ©ç”¨ã™ã‚‹
                            </button>
                            <p id="location-status" class="text-sm text-center text-gray-500 mt-2 h-5"></p>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="border border-gray-300 rounded-lg p-6">
                    <legend class="text-xl font-semibold text-gray-700 px-2">
                        <span class="text-orange-600">2.</span> ã©ã‚“ãªæ°—åˆ†ï¼Ÿ
                    </legend>
                    
                    <div id="preferences-container" class="space-y-2 mt-4 max-h-96 overflow-y-auto pr-2">
                        </div>
                </fieldset>

                <fieldset class="border border-gray-300 rounded-lg p-6">
                    <legend class="text-xl font-semibold text-gray-700 px-2">
                        <span class="text-orange-600">3.</span> ã©ã®ãã‚‰ã„ï¼Ÿ
                    </legend>
                    
                    <div class="space-y-4 mt-4">
                        <div>
                            <label for="trip-duration" class="block text-sm font-semibold text-gray-700 mb-2">æ™‚é–“ã®èª¬æ˜ (ä¾‹: ç´„3æ™‚é–“)</label>
                            <input type="text" id="trip-duration"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition duration-200"
                                   value="ç´„4ã€œ5æ™‚é–“ï¼ˆæ˜¼é£Ÿã¨ã‚«ãƒ•ã‚§ä¼‘æ†©ã‚’å«ã‚€ï¼‰" required>
                        </div>
                    </div>
                </fieldset>
                

                <div class="pt-4">
                    <button type="submit" id="submit-button"
                            class="w-full bg-orange-600 text-white text-lg font-bold py-3 px-6 rounded-lg shadow-md hover:bg-orange-700 focus:outline-none focus:ring-4 focus:ring-orange-500 focus:ring-opacity-50 transition duration-300 ease-in-out transform hover:-translate-y-0.5">
                        ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã™ã‚‹
                    </button>
                </div>
            </form>

            <div id="error-message" class="mt-6 text-center text-red-600 font-semibold hidden"></div>

        </div>
    </div>


    <script>
        
        let GOOGLE_MAPS_API_KEY = null;
        // 1ï¸âƒ£ Láº¥y API key tá»« backend
        fetch("/api/config")
            .then(response => response.json())
            .then(config => {
                GOOGLE_MAPS_API_KEY = config.googleMapsKey;

                if (!GOOGLE_MAPS_API_KEY) {
                    console.error("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c Google Maps API Key");
                    return;
                }

                // 2ï¸âƒ£ Sau khi cÃ³ key â†’ load Google Maps
                loadGoogleMapsScript();
            })
            .catch(err => {
                console.error("âŒ Lá»—i khi fetch config:", err);
            });

        // === ğŸš€ CODE Má»šI: Tá»° Äá»˜NG Táº¢I SCRIPT GOOGLE MAPS Vá»šI KEY á» TRÃŠN ===
        function loadGoogleMapsScript() {
            const script = document.createElement('script');
            // Sá»­ dá»¥ng Template Literal (dáº¥u backtick ` `) Ä‘á»ƒ chÃ¨n biáº¿n ${GOOGLE_MAPS_API_KEY}
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=initAutocomplete`;
            script.async = true;
            script.defer = true;
            document.body.appendChild(script);
        }

        // Biáº¿n toÃ n cá»¥c Ä‘á»ƒ lÆ°u tá»a Ä‘á»™
        let selectedLat = null;
        let selectedLng = null;

        /**
         * 1. Khá»Ÿi táº¡o Google Places Autocomplete
         */
        function initAutocomplete() {
            const input = document.getElementById('location-input');
            const options = {
                fields: ["geometry", "name"],
                types: ["geocode"],
            };
            const autocomplete = new google.maps.places.Autocomplete(input, options);

            autocomplete.addListener('place_changed', () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    console.log("ã“ã®å ´æ‰€ã®åº§æ¨™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    return;
                }
                
                selectedLat = place.geometry.location.lat();
                selectedLng = place.geometry.location.lng();
                
                updateLocationStatus(`è¨­å®šå®Œäº†: ${place.name}`, 'green');
                console.log(`å ´æ‰€ã‚’é¸æŠã—ã¾ã—ãŸ: ${place.name} (${selectedLat}, ${selectedLng})`);
            });
        }

        /**
         * 2. Láº¥y vá»‹ trÃ­ hiá»‡n táº¡i
         */
        function handleCurrentLocation() {
            const btn = document.getElementById('current-location-btn');
            btn.disabled = true;
            updateLocationStatus('åº§æ¨™ã‚’å–å¾—ä¸­...', 'orange');
            
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        selectedLat = position.coords.latitude;
                        selectedLng = position.coords.longitude;
                        
                        document.getElementById('location-input').value = 'ç¾åœ¨åœ° (åº§æ¨™)';
                        updateLocationStatus('ç¾åœ¨åœ°ã®åº§æ¨™ã‚’å–å¾—ã—ã¾ã—ãŸï¼', 'green');
                        console.log(`ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸ: (${selectedLat}, ${selectedLng})`);
                        btn.disabled = false;
                    },
                    (error) => {
                        console.error("Lá»—i Geolocation:", error);
                        let msg = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                        if (error.code === 1) msg = "ä½ç½®æƒ…å ±ã®å–å¾—ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚";
                        if (error.code === 2) msg = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
                        if (error.code === 3) msg = "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚";
                        updateLocationStatus(msg, 'red');
                        btn.disabled = false;
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                updateLocationStatus('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚', 'red');
                btn.disabled = false;
            }
        }
        
        /**
         * 3. Hiá»ƒn thá»‹ thÃ´ng bÃ¡o tráº¡ng thÃ¡i vá»‹ trÃ­
         */
        function updateLocationStatus(message, color) {
            const statusEl = document.getElementById('location-status');
            statusEl.textContent = message;
            statusEl.className = `text-sm text-center mt-2 h-5 text-${color}-600`;
        }

        /**
         * 4. Render danh sÃ¡ch sá»Ÿ thÃ­ch tá»« JSON
         */
        function renderPreferences() {
            try {
                const data = JSON.parse(document.getElementById('preferences-data').textContent);
                const container = document.getElementById('preferences-container');
                let html = '';

                data.forEach(purpose => {
                    html += `
                        <details class="border rounded-lg overflow-hidden transition-all duration-300 bg-white shadow-sm">
                            <summary class="p-4 cursor-pointer hover:bg-gray-50 flex justify-between items-center">
                                <div>
                                    <h3 class="font-semibold text-lg text-gray-800">${purpose.name_jp}</h3>
                                    <p class="text-sm text-gray-500">${purpose.description_jp}</p>
                                </div>
                            </summary>
                            <div class="p-4 bg-gray-50 border-t border-gray-200 grid grid-cols-2 gap-x-4 gap-y-2">
                    `;
                    
                    if (purpose.preferences.length > 0) {
                        purpose.preferences.forEach(pref => {
                            html += `
                                <label for="${pref.id}" class="flex items-center space-x-2 p-2 rounded-md hover:bg-orange-100 cursor-pointer">
                                    <input type="checkbox" id="${pref.id}" name="preferences" value="${pref.id}" class="form-check h-4 w-4">
                                    <span class="text-sm text-gray-700">${pref.name_jp}</span>
                                </label>
                            `;
                        });
                    } else {
                        // TrÆ°á»ng há»£p Ä‘áº·c biá»‡t "Surprise"
                         html += `
                            <label for="${purpose.id}" class="flex items-center space-x-2 p-2 rounded-md hover:bg-orange-100 cursor-pointer col-span-2">
                                <input type="checkbox" id="${purpose.id}" name="preferences" value="${purpose.id}" class="form-check h-4 w-4">
                                <span class="text-sm text-gray-700">AIã«ãŠã¾ã‹ã›ã™ã‚‹</span>
                            </label>
                        `;
                    }

                    html += `</div></details>`;
                });
                
                container.innerHTML = html;
                
                // Má»Ÿ sáºµn má»¥c Ä‘áº§u tiÃªn (Du lá»‹ch)
                container.querySelector('details').open = true;

            } catch (e) {
                console.error("Lá»—i khi render JSON:", e);
                document.getElementById('preferences-container').innerHTML = 
                    '<p class="text-red-600">è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>';
            }
        }


        // === HÃ€M Má»šI (POLLING) ===
        /**
         * 5. HÃ€M Má»šI: Báº¯t Ä‘áº§u "Há»i thÄƒm" (Polling)
         */
        async function pollForJobStatus(job_id, errorDiv, submitButton) {
            let running = true;
            let attempts = 0;
            const maxAttempts = 30; // Chá» tá»‘i Ä‘a 30 láº§n * 5 giÃ¢y = 150 giÃ¢y

            while (running && attempts < maxAttempts) {
                attempts++;
                
                try {
                    // Chá» 5 giÃ¢y trÆ°á»›c khi "há»i thÄƒm"
                    await new Promise(resolve => setTimeout(resolve, 5000));

                    console.log(`ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªä¸­... job_id: ${job_id} (å›æ•° ${attempts})`);
                    
                    // Sá»¬A: DÃ¹ng Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i
                    const response = await fetch(`/api/check-status?job_id=${job_id}`, {
                        method: 'GET'
                    });

                    if (!response.ok) {
                        throw new Error(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (!result.success) {
                         throw new Error(result.error || "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªä¸­ã«ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                    }

                    // Xá»­ lÃ½ káº¿t quáº£ "há»i thÄƒm"
                    switch (result.data.status) {
                        case 'complete':
                            console.log("Job HOÃ€N THÃ€NH!", result.data);
                            // Sá»¬A: DÃ¹ng Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i (route)
                            const planUrl = result.data.planFile; // ÄÃ¢y lÃ  /json/Gemini...
                            // Chuyá»ƒn sang trang /map vÃ  truyá»n planFile qua URL
                            window.location.href = `/map?planFile=${encodeURIComponent(planUrl)}`; 
                            running = false; // Dá»«ng vÃ²ng láº·p
                            break;
                        case 'error':
                            console.error("ã‚¸ãƒ§ãƒ–å¤±æ•—:", result.data.error);
                            errorDiv.textContent = `ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${result.data.error}`;
                            errorDiv.classList.remove('hidden');
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã™ã‚‹';
                            running = false; // Dá»«ng vÃ²ng láº·p
                            break;
                        case 'running':
                        default:
                            console.log("å‡¦ç†ä¸­... 5ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™");
                            // VÃ²ng láº·p sáº½ tá»± Ä‘á»™ng tiáº¿p tá»¥c
                            break;
                    }

                } catch (error) {
                    console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚¨ãƒ©ãƒ¼:", error);
                    // Náº¿u lá»—i (vÃ­ dá»¥: máº¥t máº¡ng), chÃºng ta cÅ©ng dá»«ng láº¡i
                    errorDiv.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                    errorDiv.classList.remove('hidden');
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã™ã‚‹';
                    running = false; 
                }
            }
            
            if (attempts >= maxAttempts) {
                 console.error("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ150ç§’ï¼‰ã—ã¾ã—ãŸã€‚");
                 errorDiv.textContent = "å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
                 errorDiv.classList.remove('hidden');
                 submitButton.disabled = false;
                 submitButton.innerHTML = 'ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã™ã‚‹';
            }
        }


        /**
         * 6. Xá»­ lÃ½ Form Submit (PhiÃªn báº£n "Polling")
         */
        function handleFormSubmit(event) {
            event.preventDefault(); // NgÄƒn form gá»­i Ä‘i
            const errorDiv = document.getElementById('error-message');
            const submitButton = document.getElementById('submit-button');
            errorDiv.classList.add('hidden'); 
            
            // 1. Láº¥y táº¥t cáº£ dá»¯ liá»‡u (Giá»¯ nguyÃªn)
            const selectedPreferences = [];
            document.querySelectorAll('input[name="preferences"]:checked').forEach(cb => {
                selectedPreferences.push(cb.value);
            });
            const tripDuration = document.getElementById('trip-duration').value;

            // 2. Kiá»ƒm tra (Validate) (Giá»¯ nguyÃªn)
            if (selectedLat === null || selectedLng === null) {
                errorDiv.textContent = 'å‡ºç™ºåœ°ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚ï¼ˆæ¤œç´¢ã¾ãŸã¯ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ï¼‰';
                errorDiv.classList.remove('hidden');
                return;
            }
            if (selectedPreferences.length === 0) {
                errorDiv.textContent = 'èˆˆå‘³ã®ã‚ã‚‹é …ç›®ã‚’ä¸€ã¤ä»¥ä¸Šé¸ã‚“ã§ãã ã•ã„ã€‚';
                errorDiv.classList.remove('hidden');
                return;
            }
            if (tripDuration.trim() === '') {
                errorDiv.textContent = 'æ—…è¡Œæ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                errorDiv.classList.remove('hidden');
                return;
            }

            // 3. Chuáº©n bá»‹ dá»¯ liá»‡u Ä‘á»ƒ gá»­i (Giá»¯ nguyÃªn)
            const formData = {
                location: {
                    lat: selectedLat,
                    lng: selectedLng
                },
                preferences: selectedPreferences,
                duration: tripDuration
            };
            
            console.log("--- é€ä¿¡ãƒ‡ãƒ¼ã‚¿ (POST) ---");
            console.log(JSON.stringify(formData, null, 2));

            // 4. VÃ´ hiá»‡u hÃ³a nÃºt vÃ  hiá»ƒn thá»‹ loading
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆä¸­... (ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„)
            `;
            
            // 5. âš ï¸ Gá»ŒI BACKEND Äá»‚ Báº®T Äáº¦U JOB (Sá»¬A: ÄÆ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i) âš ï¸
            fetch('/api/start-job', { // <-- Sá»¬A: Bá» http://127...
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
            })
            .then(response => {
                if (response.status !== 202) { // 202 Accepted
                    throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.job_id) {
                    // 6. âš ï¸ THÃ€NH CÃ”NG! Báº®T Äáº¦U "Há»I THÄ‚M" âš ï¸
                    console.log("ã‚¸ãƒ§ãƒ–ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ID:", data.job_id);
                    pollForJobStatus(data.job_id, errorDiv, submitButton);
                } else {
                    throw new Error(data.error || "ã‚¸ãƒ§ãƒ–ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä¸æ˜ãªã‚¨ãƒ©ãƒ¼ï¼‰ã€‚");
                }
            })
            .catch(error => {
                // Xá»­ lÃ½ lá»—i (lá»—i máº¡ng, server crash, v.v.)
                console.error("/api/start-job å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:", error);
                errorDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`;
                errorDiv.classList.remove('hidden');
                submitButton.disabled = false;
                submitButton.innerHTML = 'ãƒ—ãƒ©ãƒ³ã‚’ä½œæˆã™ã‚‹';
            });
        }
        
        // --- JAVASCRIPT Má»šI CHO HEADER ---
        
        /**
         * 7. (Má»šI) Láº¥y thÃ´ng tin User khi táº£i trang
         */
        async function fetchUserProfile() {
            try {
                const response = await fetch('/api/profile');
                if (!response.ok) {
                    // Náº¿u khÃ´ng nháº­n Ä‘Æ°á»£c 200 OK (vÃ­ dá»¥: 401 ChÆ°a Ä‘Äƒng nháº­p)
                    // Server sáº½ tá»± Ä‘á»™ng redirect, nhÆ°ng Ä‘á» phÃ²ng
                    window.location.href = '/login'; 
                    return;
                }
                const result = await response.json();
                if (result.success && result.nickname) {
                    document.getElementById('welcome-nickname').textContent = result.nickname;
                }
            } catch (error) {
                console.error("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
                // Náº¿u fetch lá»—i, quay vá» trang login
                window.location.href = '/login';
            }
        }

        /**
         * 8. (Má»šI) Xá»­ lÃ½ ÄÄƒng xuáº¥t
         */
        async function handleLogout() {
            try {
                const response = await fetch('/api/logout', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    window.location.href = '/login'; // Chuyá»ƒn vá» trang login
                }
            } catch (error) {
                console.error("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:", error);
                alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
            }
        }

        /**
         * 9. (Má»šI) Gáº¯n Listener khi DOM Ä‘Ã£ táº£i xong
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Táº£i Script Google Maps
            loadGoogleMapsScript();

            // Render sá»Ÿ thÃ­ch
            renderPreferences();
            
            // Gáº¯n listener cho nÃºt Vá»‹ trÃ­ hiá»‡n táº¡i
            document.getElementById('current-location-btn').addEventListener('click', handleCurrentLocation);
            
            // Gáº¯n listener cho Form
            document.getElementById('mainForm').addEventListener('submit', handleFormSubmit);

            // === Gáº®N LISTENER CHO HEADER Má»šI ===
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenu = document.getElementById('user-menu');
            const logoutButton = document.getElementById('logout-button');

            // 1. Láº¥y thÃ´ng tin user
            fetchUserProfile();

            // 2. Báº­t/táº¯t dropdown
            userMenuButton.addEventListener('click', () => {
                const isHidden = userMenu.classList.contains('hidden');
                userMenu.classList.toggle('hidden', !isHidden);
            });

            // 3. Xá»­ lÃ½ Ä‘Äƒng xuáº¥t
            logoutButton.addEventListener('click', handleLogout);

            // 4. (TÃ¹y chá»n) ÄÃ³ng dropdown khi click ra ngoÃ i
            window.addEventListener('click', (e) => {
                if (!userMenuButton.contains(e.target) && !userMenu.contains(e.target)) {
                    userMenu.classList.add('hidden');
                }
            });
        });
        
    </script>
    
</body>
</html>